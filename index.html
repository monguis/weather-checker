<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Weather Checker</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

</head>

<body>
    <div class="container">
        <div class="row">
            <h1 class="col">
                Weather Dashboard
            </h1>
        </div>

        <div class="row">
            <div class="col-3">
                <label for="cityInput">Search for a City </label>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Recipient's username"
                        aria-label="Recipient's username" aria-describedby="button-addon2" id="cityInput">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" id="SearchBtn">Button</button>
                    </div>
                </div>
                <div id="cityHistory">

                </div>
            </div>
            <div class="col-9">
                <div class="row" id="CurrentConditions">
                    <h2 id="cityName">

                    </h2>
                </div>
                <div class="row">
                    <div class="col">
                        <div id="cityTemp">

                        </div>
                        <div id="cityHum">

                        </div>
                        <div id="cityWindS">

                        </div>
                        <div id="UVIndex">

                        </div>
                    </div>
                </div>
                <div class="row" id="cityForecast">

                </div>
            </div>
        </div>
    </div>
















    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript">

var storedCities = JSON.parse(localStorage.getItem("cities"));
var cityArray = [];
renderCityBtns()

        function renderForecast(auxRes) {
            var forecastDiv = $("#cityForecast").empty();
            forecastDiv
            var icon, date, temp, humidity;
            for (var i = 5; i < auxRes.list.length; i += 8) {

                var auxDiv = $("<div class = 'col-2'>").attr("id", i);
                date = $("<div>").text(auxRes.list[i].dt_txt);
                icon = $("<img>").attr("src", "http:openweathermap.org/img/wn/" + auxRes.list[i].weather[0].icon + "@2x.png");
                temp = $("<div>").text("Temp: " + auxRes.list[i].main.temp + "°F");
                humidity = $("<div>").text("Humidity: " + auxRes.list[i].main.humidity + "%");
                forecastDiv.append(auxDiv.append(date, icon, temp, humidity));
            }
        }

        function renderWeather(auxRex) {
            var name, date, temp, humidity, UVIndex, windS;
            $("#cityName").text(auxRex.name + " (" + "fechahehe" + ")");
            $("#cityTemp").text(auxRex.main.temp + "°F");
            $("#cityHum").text("Humidity: " + auxRex.main.humidity + "%")
            $("#cityWindS").text("Wind Speed: " + auxRex.wind.speed + " MPH");
            $("#UVIndex").text("UVIndex: ");
        }

        function AskAjax(queryText) {
            var APIKey = "a7bd77b04beba420ad9eb5dbe7386e23";
            var queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + queryText + "&units=imperial&appid=" + APIKey;
            $.ajax({
                url: queryURL,
                method: "GET"
            }).then(function (response) {
                renderWeather(response)
                    if(!cityArray.includes(response.name)){
                    cityArray.push(response.name);
                    
                renderCityBtns();
                }
            });

            $.ajax({
                url: `https://api.openweathermap.org/data/2.5/forecast?q=${queryText}&units=imperial&appid=${APIKey} `,
                method: "GET"
            }).then(function (response) {
                renderForecast(response);
            });


        }

        function renderCityBtns() {
            $("#cityHistory").empty();
            if (storedCities) {
                cityArray = storedCities;
            } else {
                localStorage.setItem("cities", JSON.stringify(cityArray));
                return;
            }
            console.log(cityArray)
            var a
            var history = $("#cityHistory");
            cityArray.forEach(function (element) {
                a = $("<button class ='cityBtn' data-name = '" + element + "'>").text(element);
                    console.log(element)
                history.append(a);
            });
            localStorage.setItem("cities", JSON.stringify(cityArray));
        }

        $("#SearchBtn").on("click", function (evt) {
            evt.preventDefault();
            if ($("#cityInput").val()) {
                AskAjax($("#cityInput").val());
                
                $("#cityInput").val("");
            }
        });
        $("#cityHistory").on("click", ".cityBtn",function(evt){
           evt.preventDefault();
           console.log("entro al evento");
           AskAjax($(this).attr("data-name"));
       })

    </script>

</body>

</html>